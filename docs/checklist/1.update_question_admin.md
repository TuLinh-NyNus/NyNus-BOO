# PLAN: Update Admin Question Management (apps/frontend)

## 0) Scope & Objectives
- Mục tiêu: Xây dựng lại trang Admin Quản lý Câu hỏi tại apps/frontend, kết hợp CRUD quản trị (temp1/admin/FE) với luồng nhập LaTeX/MapID/saved (temp1/web), dùng mock services (không kết nối backend thật), theo Next.js 14 App Router, TypeScript strict, Tailwind + Shadcn UI.
- Kết quả: Bộ trang Questions hoàn chỉnh (list, create, edit, input LaTeX, input auto, database, saved, map-id), component modular, mock API đầy đủ (CRUD + paging/filter/search), pass pnpm build/dev.

---

## 1) Breakdown Tasks (Ưu tiên: Pages → Components → Services → Integration)

### 1.1 Pages (P0)
- [ ] Create List Page: apps/frontend/src/app/3141592654/admin/questions/page.tsx
  - Hiển thị bảng câu hỏi, filters, bulk actions, pagination
- [ ] Create Create Page: apps/frontend/src/app/3141592654/admin/questions/create/page.tsx
  - Form tabs: Basic, Answers, LaTeX, MapID, Preview
- [ ] Create Edit Page: apps/frontend/src/app/3141592654/admin/questions/[id]/edit/page.tsx
  - Nạp dữ liệu mock theo id, chỉnh sửa + lưu mock
- [ ] Create Input LaTeX Page: apps/frontend/src/app/3141592654/admin/questions/inputques/page.tsx
  - Textarea nhập LaTeX, parse mock, fill form
- [ ] Create Input Auto Page: apps/frontend/src/app/3141592654/admin/questions/inputauto/page.tsx
  - Upload tệp lớn (mock), preview kết quả parse
- [ ] Create Database Page: apps/frontend/src/app/3141592654/admin/questions/database/page.tsx
  - Xem “kho” mock, duyệt/preview
- [ ] Create Saved Page: apps/frontend/src/app/3141592654/admin/questions/saved/page.tsx
  - Đọc localStorage saved questions (mock)
- [ ] Create MapID Page: apps/frontend/src/app/3141592654/admin/questions/map-id/page.tsx
  - Công cụ tra cứu/giải mã MapID và gợi ý questionCodeId

Acceptance (P0):
- UI render không lỗi; điều hướng menu hoạt động; mỗi page gọi mock service; responsive >= md; no console errors.

### 1.2 Components (P0/P1)
- [ ] list/questionList.tsx (P0): bảng + chọn dòng + phân trang
- [ ] list/questionFilters.tsx (P0): bộ lọc (type, status, difficulty, code prefix, keyword)
- [ ] list/questionBulkActions.tsx (P0): cập nhật trạng thái hàng loạt, xóa
- [ ] form/questionForm.tsx (P0): Basic + Answers
- [ ] form/questionFormTabs.tsx (P0): Tabs gộp Form/LaTeX/MapID/Preview
- [ ] preview/questionPreview.tsx (P1): xem trước nội dung/đáp án
- [ ] mapid/mapIdDecoder.tsx (P1): decode/hiển thị tham số từ code
- [ ] bank/questionBank.tsx (P1): list kiểu “database”
- [ ] shared/* (P1): toolbar/empty-state/skeleton

Acceptance (P0/P1):
- Props rõ ràng, type-safe, function < 20 lines, files < 300 lines; hoạt động với mock; responsive.

### 1.3 Services (P0)
- [ ] lib/services/mock/questions.ts: CRUD + paging/filter/search + bulk
- [ ] lib/mappers/question-mapper.ts: camelCase ↔ snake_case (chuẩn bị cho BE thật)
- [ ] Seed mock dataset (80–120 records) đa dạng enums/tags/code

Acceptance:
- API hợp đồng rõ ràng; các page gọi được; search/filter/pagination hiệu lực trong mock.

### 1.4 Integration (P0)
- [ ] Cập nhật admin-paths.ts với 5 routes mới (inputques, inputauto, database, saved, map-id)
- [ ] Mở rộng admin-navigation.ts với submenu đầy đủ cho questions
- [ ] Routing & navigation: liên kết ADMIN_PATHS/admin-navigation
- [ ] Wire pages ↔ components ↔ services
- [ ] Tạo error boundaries cho từng page
- [ ] Setup toast notification system
- [ ] Implement loading skeletons cho table, form, preview
- [ ] Empty/Error/Loading states + toasts

### 1.5 Validation & Security (P0)
- [ ] Tạo Zod schemas cho tất cả forms với validation rules chi tiết
- [ ] Error messages tiếng Việt cho validation
- [ ] Implement input sanitization cho LaTeX content
- [ ] Setup file upload validation (type, size limits)
- [ ] XSS prevention cho question content
- [ ] Conditional validation dựa trên question type

### 1.6 Performance (P1)
- [ ] Implement React.lazy() cho components lớn (FormTabs, Bank, Preview)
- [ ] Setup useDebounce cho search (300ms delay)
- [ ] Virtual scrolling cho large question lists
- [ ] Bundle splitting optimization
- [ ] Image optimization cho question content

### 1.7 Testing (P1)
- [ ] Unit tests cho mock services (Jest)
- [ ] Component tests cho critical components
- [ ] E2E tests cho main user journeys (create, edit, search)
- [ ] Performance testing setup
- [ ] Accessibility testing checklist

Acceptance:
- pnpm build; pnpm dev chạy không lỗi; điều hướng trơn tru; hành động mock hoạt động; validation hoạt động; performance tối ưu.

---

## 2) Implementation Plan (Chi tiết)

### 2.1 Cấu trúc thư mục
apps/frontend/src/app/3141592654/admin/questions/
- page.tsx
- create/page.tsx
- [id]/edit/page.tsx
- inputques/page.tsx
- inputauto/page.tsx
- database/page.tsx
- saved/page.tsx
- map-id/page.tsx

apps/frontend/src/components/admin/questions/
- list/questionList.tsx
- list/questionFilters.tsx
- list/questionBulkActions.tsx
- form/questionForm.tsx
- form/questionFormTabs.tsx
- preview/questionPreview.tsx
- mapid/mapIdDecoder.tsx
- bank/questionBank.tsx
- shared/{tableEmpty.tsx, tableToolbar.tsx, tableSkeleton.tsx}

apps/frontend/src/lib/types/question.ts
apps/frontend/src/lib/services/mock/questions.ts
apps/frontend/src/lib/mappers/question-mapper.ts

### 2.2 Interfaces & Props (tóm lược)
- interface Question {
  id: string;
  rawContent: string; content: string; subcount?: string;
  type: 'MC'|'TF'|'SA'|'ES'|'MA'; source?: string;
  answers?: AnswerOption[]|MatchingOption[];
  correctAnswer?: CorrectAnswer;
  solution?: string; tag?: string[];
  usageCount?: number; creator?: string;
  status?: 'ACTIVE'|'PENDING'|'INACTIVE'|'ARCHIVED';
  feedback?: number; difficulty?: 'EASY'|'MEDIUM'|'HARD';
  createdAt: string; updatedAt: string;
  questionCodeId: string;
}
- interface AnswerOption { id: string; content: string; isCorrect?: boolean }
- interface MatchingPair { left: string; right: string }
- type MatchingOption = MatchingPair
- type CorrectAnswer =
  | { kind: 'MC'; values: string[] }
  | { kind: 'TF'; values: string[] }
  | { kind: 'SA'; values: string[] }
  | { kind: 'ES'; values: string[] }
  | { kind: 'MA'; pairs: MatchingPair[] }
- interface QuestionCode { code: string; format: 'ID5'|'ID6'; grade: string; subject: string; chapter: string; lesson: string; form?: string; level: string }

- questionList props: { data: Question[]; isLoading: boolean; selectedIds: string[]; onToggleSelect(id); onToggleSelectAll(checked); onEdit(id); onDelete(id); pagination:{page,pageSize,total}; onPageChange(page); onPageSizeChange(ps) }
- questionFilters props: { value:{ type?, status?, difficulty?, codePrefix?, keyword? }; onChange(value) }
- questionBulkActions props: { selectedIds: string[]; onBulkDelete(ids); onBulkUpdateStatus(ids,status) }
- questionForm props: { value: QuestionDraft; onChange(draft); errors?: string[] }
- questionFormTabs props: { form: ReactNode; latex: ReactNode; mapid: ReactNode; preview: ReactNode }
- mapIdDecoder props: { code?: string; onDecode(result) }

### 2.3 Mock services API contracts
- listQuestions(params: {
  page: number; pageSize: number;
  type?: Question['type']; status?: Question['status']; difficulty?: Question['difficulty'];
  codePrefix?: string; keyword?: string; sortBy?: 'createdAt'|'updatedAt'|'usageCount'; sortDir?: 'asc'|'desc';
}): Promise<{ data: Question[]; page: number; pageSize: number; total: number }>
- getQuestion(id: string): Promise<{ data?: Question; error?: string }>
- createQuestion(payload: Omit<Question,'id'|'createdAt'|'updatedAt'>): Promise<{ data: Question }>
- updateQuestion(id: string, payload: Partial<Omit<Question,'id'>>): Promise<{ data: Question }>
- deleteQuestion(id: string): Promise<{ ok: true }>
- bulkUpdateStatus(ids: string[], status: Question['status']): Promise<{ updated: number }>
- bulkDelete(ids: string[]): Promise<{ deleted: number }>
- parseLatexContent(latex: string): Promise<{ data: Partial<Question>; error?: string }>
- uploadAutoFile(file: File): Promise<{ data: Question[]; error?: string }>
- getSavedQuestions(): Promise<{ data: Question[] }>
- saveQuestion(question: Question): Promise<{ ok: true }>
- decodeMapId(code: string): Promise<{ data: QuestionCode; error?: string }>

**Mock Data Strategy:**
- Simulate latency 200–400ms cho realistic UX
- Dataset seed 80–120 records với distribution:
  - Type: MC(40%), TF(20%), SA(15%), ES(15%), MA(10%)
  - Status: ACTIVE(70%), PENDING(15%), INACTIVE(10%), ARCHIVED(5%)
  - Difficulty: EASY(30%), MEDIUM(50%), HARD(20%)
- QuestionCode format: ID6 (7 ký tự) - Grade(1) + Subject(2) + Chapter(2) + Lesson(1) + Level(1)
- MapID decoding: Reverse engineering từ questionCodeId
- LaTeX parsing: Mock convert LaTeX syntax → Question fields
- localStorage saved questions: Array<Question> với key 'saved_questions'

### 2.4 Routing & Navigation
- Cập nhật ADMIN_PATHS với routes mới:
  ```typescript
  QUESTIONS_INPUT_LATEX: '/3141592654/admin/questions/inputques',
  QUESTIONS_INPUT_AUTO: '/3141592654/admin/questions/inputauto',
  QUESTIONS_DATABASE: '/3141592654/admin/questions/database',
  QUESTIONS_SAVED: '/3141592654/admin/questions/saved',
  QUESTIONS_MAP_ID: '/3141592654/admin/questions/map-id',
  ```
- Mở rộng questions children trong admin-navigation.ts:
  ```typescript
  children: [
    { name: 'Danh sách', href: '/questions', icon: 'List' },
    { name: 'Tạo mới', href: '/questions/create', icon: 'Plus' },
    { name: 'Nhập LaTeX', href: '/questions/inputques', icon: 'FileText' },
    { name: 'Nhập tự động', href: '/questions/inputauto', icon: 'Upload' },
    { name: 'Kho câu hỏi', href: '/questions/database', icon: 'Database' },
    { name: 'Đã lưu', href: '/questions/saved', icon: 'Bookmark' },
    { name: 'Map ID', href: '/questions/map-id', icon: 'Map' }
  ]
  ```
- Links chính:
  - /3141592654/admin/questions (list)
  - /3141592654/admin/questions/create
  - /3141592654/admin/questions/[id]/edit
  - /3141592654/admin/questions/inputques
  - /3141592654/admin/questions/inputauto
  - /3141592654/admin/questions/database
  - /3141592654/admin/questions/saved
  - /3141592654/admin/questions/map-id

### 2.5 Type alignment với DB schema
- Enums theo DB: type: MC|TF|SA|ES|MA; status: ACTIVE|PENDING|INACTIVE|ARCHIVED; difficulty: EASY|MEDIUM|HARD
- Field mapping chuẩn bị mapper FE↔BE:
  - rawContent ↔ raw_content; correctAnswer ↔ correct_answer; questionCodeId ↔ question_code_id; usageCount ↔ usage_count; createdAt ↔ created_at; updatedAt ↔ updated_at
- answers/correctAnswer giữ JSON shape theo union ở FE; khi nối BE sẽ map keys, không đổi cấu trúc giá trị.

---

## 3) Dependencies & Constraints
- **UI Components**: Button, Card, Tabs, Table, Input, Label, Badge, Alert, Toast, Skeleton, Dialog, Form từ apps/frontend/src/components/ui (Shadcn UI)
- **Utilities có sẵn**: admin-navigation, admin-paths, error-boundary, toast system
- **Form Libraries**: React Hook Form + Zod validation
- **Icons**: Lucide React (List, Plus, FileText, Upload, Database, Bookmark, Map)

**Mock Data Requirements:**
- Distribution: Type/Status/Difficulty theo tỷ lệ realistic
- QuestionCode: ID6 format (Grade+Subject+Chapter+Lesson+Level)
- Tags đa dạng: môn học, chủ đề, độ khó, nguồn
- Seeding strategy: Deterministic với faker.js hoặc manual data
- CreatedAt/UpdatedAt: Spread trong 6 tháng gần đây
- UsageCount: Random 0-100 với weighted distribution

**Validation Strategy:**
- Zod schemas cho tất cả forms
- Error messages tiếng Việt
- Real-time validation cho critical fields
- File upload: max 10MB, .tex/.txt/.csv formats
- LaTeX syntax: Basic validation cho common patterns

**Performance Constraints:**
- Lazy load: FormTabs, QuestionBank, Preview components
- Debounce search: 300ms delay
- Pagination: 20 items/page default, max 100
- Virtual scrolling: Lists > 100 items
- Bundle splitting: Separate chunks cho heavy components

**Testing Requirements:**
- Unit tests: 80%+ coverage cho services
- Component tests: Critical user flows
- E2E tests: Create, Edit, Search, Filter workflows
- Performance: < 2s page load, < 500ms interactions
- Accessibility: WCAG 2.1 AA compliance

---

## 4) Risk Mitigation & Quality Assurance

**Potential Blockers & Solutions:**
- **File size violations** (<300 lines):
  - Tách components ngay từ đầu theo functional areas
  - Extract custom hooks cho complex logic
  - Separate utility functions vào lib/utils
- **Complex LaTeX/MapID features**:
  - Phase 1: Basic text input/output (no rendering)
  - Phase 2: Add syntax highlighting
  - Phase 3: Live preview (if needed)
- **Performance issues**:
  - Monitor bundle size với webpack-bundle-analyzer
  - Implement progressive loading
  - Use React.memo cho expensive components
- **Mock data complexity**:
  - Start với 50 records, scale up gradually
  - Use pagination để handle large datasets
  - Implement search/filter client-side first

**Code Quality Checkpoints:**
- **Pre-commit**: ESLint + Prettier + TypeScript strict
- **Build validation**: pnpm build success
- **Runtime validation**: pnpm dev no console errors
- **Code standards**: Functions <20 lines, SRP, early returns
- **Performance**: Lighthouse score >90, bundle size <500KB
- **Accessibility**: Screen reader compatible, keyboard navigation

**Testing Checkpoints:**
- **Unit tests**: All services và critical utilities
- **Integration tests**: Form submissions, API calls
- **E2E tests**: Complete user workflows
- **Manual testing**: Cross-browser, responsive design
- **Performance testing**: Load time, interaction responsiveness

---

## 5) Acceptance Criteria (Tổng hợp)
- UI: Tất cả pages render, điều hướng đúng, responsive, states đầy đủ (empty/error/loading)
- Mock: CRUD + paging + filter + search hoạt động ở client
- Build: pnpm build thành công; pnpm dev chạy không lỗi
- Code: Tuân thủ standards; đặt tên theo schema; component modular

---

## 6) Estimated Timeline (Updated)

**Phase 1 - Foundation (1 ngày):**
- Setup: Admin paths, navigation, types, mock services
- Core infrastructure: Error boundaries, loading states, validation schemas

**Phase 2 - Core Features (2-3 ngày):**
- Pages P0: List, Create, Edit, Input LaTeX
- Components P0: QuestionList, QuestionForm, QuestionFilters, BulkActions
- Integration: Routing, navigation, basic CRUD operations

**Phase 3 - Advanced Features (1-2 ngày):**
- Pages P1: Database, Saved, Map-ID, Input Auto
- Components P1: QuestionPreview, QuestionBank, MapIdDecoder
- Advanced features: File upload, LaTeX parsing, localStorage

**Phase 4 - Polish & Testing (1 ngày):**
- Performance optimization: Lazy loading, debouncing
- Testing: Unit tests, E2E tests, manual testing
- Bug fixes, UI polish, documentation

**Total: 5-7 ngày** (vs original 3.5-5.5 ngày)
- Increase due to added validation, testing, and performance work
- More realistic timeline với quality assurance

---

## 7) Next Steps (EXECUTE readiness)

**Immediate Actions (Phase 1):**
1. **Setup Infrastructure:**
   - Cập nhật admin-paths.ts với 5 routes mới
   - Mở rộng admin-navigation.ts với submenu đầy đủ
   - Tạo types/question.ts với interfaces chi tiết
   - Setup error boundaries và toast system

2. **Mock Services Foundation:**
   - Implement mock/questions.ts với full API contracts
   - Create question-mapper.ts cho data transformation
   - Seed realistic dataset (80-120 records)
   - Setup localStorage utilities cho saved questions

**Implementation Sequence (Phase 2-3):**
3. **Core Pages (P0):**
   - List page với table, filters, pagination
   - Create page với form tabs
   - Edit page với data loading
   - Input LaTeX page với parsing

4. **Advanced Pages (P1):**
   - Database page với question bank
   - Saved page với localStorage integration
   - Map-ID page với decoding tools
   - Input Auto page với file upload

5. **Quality Assurance (Phase 4):**
   - Validation schemas với Zod
   - Performance optimization
   - Unit và E2E tests
   - Cross-browser testing

**Ready to Execute:** ✅
- Codebase structure understood
- Dependencies available
- UI components ready
- Clear implementation path

