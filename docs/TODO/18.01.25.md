# TODO: Google Drive & OAuth Setup
**Created**: 18/01/2025  
**Priority**: HIGH  
**Target**: Production deployment

## üîê Google OAuth Setup

### 1. Google Cloud Console Configuration
- [ ] Create/Select Google Cloud Project
- [ ] Enable required APIs:
  - [ ] Google Drive API
  - [ ] Google+ API (for OAuth)
  - [ ] Google Sheets API (if needed)
- [ ] Create OAuth 2.0 Client ID:
  - Application type: Web application
  - Authorized redirect URIs:
    - `http://localhost:3000/api/auth/callback/google` (dev)
    - `https://yourdomain.com/api/auth/callback/google` (prod)
- [ ] Download credentials JSON

### 2. Environment Variables Needed
```env
# Google OAuth
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3000/api/auth/callback/google

# Google Drive API
DRIVE_CLIENT_ID=your-client-id.apps.googleusercontent.com
DRIVE_CLIENT_SECRET=your-client-secret
DRIVE_REFRESH_TOKEN=your-refresh-token
DRIVE_ROOT_FOLDER_ID=your-root-folder-id
```

### 3. Get Refresh Token
```javascript
// Use this script to get refresh token:
const { google } = require('googleapis');
const oauth2Client = new google.auth.OAuth2(
  CLIENT_ID,
  CLIENT_SECRET,
  REDIRECT_URI
);

// Generate auth URL
const authUrl = oauth2Client.generateAuthUrl({
  access_type: 'offline',
  scope: ['https://www.googleapis.com/auth/drive.file'],
});

// Visit authUrl, get code, then exchange for tokens
const { tokens } = await oauth2Client.getToken(code);
console.log('Refresh Token:', tokens.refresh_token);
```

## üìÅ Google Drive Setup

### 1. Folder Structure
- [ ] Create root folder in Google Drive: "NyNus-Question-Images"
- [ ] Set folder permissions (if shared drive)
- [ ] Get folder ID from URL: `https://drive.google.com/drive/folders/{FOLDER_ID}`

### 2. Service Account (Alternative to OAuth)
- [ ] Create Service Account in Google Cloud Console
- [ ] Download service account key JSON
- [ ] Share Google Drive folder with service account email
- [ ] Update code to use service account instead of OAuth

### 3. Quota & Limits
- **Daily Upload Limit**: 750 GB
- **Queries per 100 seconds**: 1000
- **Queries per day**: 1,000,000,000
- [ ] Implement exponential backoff for rate limiting
- [ ] Monitor quota usage in Google Cloud Console

## üîß Implementation Tasks

### Backend Updates
- [ ] Update `GoogleDriveUploader` with real credentials
- [ ] Add credential validation on startup
- [ ] Implement token refresh logic
- [ ] Add error handling for quota exceeded
- [ ] Create health check endpoint for Drive connectivity

### Security Considerations
- [ ] Never commit credentials to git
- [ ] Use secret management service (e.g., HashiCorp Vault, AWS Secrets Manager)
- [ ] Rotate refresh tokens periodically
- [ ] Implement audit logging for all Drive operations
- [ ] Set up alerts for suspicious activity

### Testing
- [ ] Test upload with different file sizes
- [ ] Test folder creation with Unicode names
- [ ] Test rate limiting behavior
- [ ] Test token refresh flow
- [ ] Test error recovery scenarios

## üìä Monitoring & Logging

### Metrics to Track
- [ ] Upload success rate
- [ ] Average upload time
- [ ] Quota usage percentage
- [ ] Failed upload reasons
- [ ] Token refresh frequency

### Alerts to Configure
- [ ] Quota > 80% used
- [ ] Upload failure rate > 5%
- [ ] Token refresh failures
- [ ] Drive API errors

## üöÄ Deployment Checklist

### Development Environment
- [x] TeX Live installed
- [x] ImageMagick installed
- [ ] Google credentials configured
- [ ] Test folder created in Drive

### Staging Environment
- [ ] All dev requirements
- [ ] Staging OAuth client
- [ ] Staging Drive folder
- [ ] Load testing completed

### Production Environment
- [ ] All staging requirements
- [ ] Production OAuth client
- [ ] Production Drive folder with backup
- [ ] Monitoring dashboard setup
- [ ] Incident response plan

## üìù Notes

### Important URLs
- Google Cloud Console: https://console.cloud.google.com
- Drive API Documentation: https://developers.google.com/drive/api/v3
- OAuth 2.0 Playground: https://developers.google.com/oauthplayground
- API Library: https://console.cloud.google.com/apis/library

### Common Issues & Solutions

1. **"Insufficient Permission" Error**
   - Check OAuth scopes
   - Verify folder permissions
   - Ensure API is enabled

2. **"Quota Exceeded" Error**
   - Implement exponential backoff
   - Consider using batch requests
   - Monitor quota in Console

3. **"Invalid Grant" Error**
   - Refresh token may be expired
   - Re-authenticate to get new token
   - Check client secret hasn't changed

### Resources
- [Google Drive API Quickstart](https://developers.google.com/drive/api/v3/quickstart/nodejs)
- [OAuth 2.0 for Server-side Apps](https://developers.google.com/identity/protocols/oauth2/web-server)
- [Best Practices for API Keys](https://cloud.google.com/docs/authentication/best-practices-applications)

## ‚è∞ Timeline
- **Phase 1** (Week 1): OAuth setup and testing
- **Phase 2** (Week 2): Drive integration and folder structure
- **Phase 3** (Week 3): Production deployment and monitoring
- **Phase 4** (Week 4): Performance optimization and backup strategy

---
**Last Updated**: 18/01/2025  
**Owner**: Backend Team  
**Review Date**: 25/01/2025